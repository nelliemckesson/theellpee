<!DOCTYPE html>
<html><head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <title>The LP - subway music</title>
<script src="d3.min.js"></script>
<script src="d3.rollup.v0.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<link rel="stylesheet" type="text/css" href="style.css">
</head>
<style>
#tooltip {
        position: absolute;
        width: 200px;
        height: auto;
        padding: 5px;
        background-color: white;
		opacity: 0.9;
        -webkit-border-radius: 5px;
        -moz-border-radius: 5px;
        border-radius: 5px;
        -webkit-box-shadow: 4px 4px 5px rgba(0, 0, 0, 0.4);
        -moz-box-shadow: 4px 4px 5px rgba(0, 0, 0, 0.4);
        box-shadow: 4px 4px 5px rgba(0, 0, 0, 0.4);
        pointer-events: none;
}

#tooltip.hidden {
        display: none;
}

#tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-weight: bold;
        font-size: 12px;
        line-height: 16px;
}

</style>

<body>
<div class="header">
<h1>LP: Find an album that fits your commute</h1>
</div>

<div id="tooltip" class="hidden">
        <p><span id="name">100</span></p>
		<p><span id="number">100</span> train</p>
</div>

<div id="route">
<p>Trip: <span id="path">(hover to select one!)</span></p>
<p>Album/Playlist: <span id="album">(you need to pick a trip first...)</span></p>
<p>Listen here: <span id="linky">(seriously, I'm not kidding...)</span></p>
</div>

<div class="label linered first">
	<p>1</p>
</div>

<div class="label linered">
	<p>2</p>
</div>

<div class="label linered">
	<p>3</p>
</div>

<div class="label linegreen">
	<p>4</p>
</div>

<div class="label linegreen">
	<p>5</p>
</div>

<div class="label linegreen">
	<p>6</p>
</div>

<div class="label linepurple">
	<p>7</p>
</div>

<div class="label lineblue">
	<p>A</p>
</div>

<div class="label lineblue">
	<p>C</p>
</div>

<div class="label lineblue">
	<p>E</p>
</div>

<div class="label lineorange">
	<p>B</p>
</div>

<div class="label lineorange">
	<p>D</p>
</div>

<div class="label lineorange">
	<p>F</p>
</div>

<div class="label lineorange">
	<p>M</p>
</div>

<div class="label linebrown">
	<p>J</p>
</div>

<div class="label linebrown">
	<p>Z</p>
</div>

<div class="label lineltgreen">
	<p>G</p>
</div>

<div class="label linegray">
	<p>L</p>
</div>

<div class="label lineyellow">
	<p>N</p>
</div>

<div class="label lineyellow">
	<p>Q</p>
</div>

<div class="label lineyellow">
	<p>R</p>
</div>

<div class="svgholder"></div>
<div class="content">
<div class="row">
<h1>What is this?</h1>
<p>My friend Kara always notices funny things in her life. A little while ago she mentioned that her commute to work was timed to allow for exactly one full listen to Neutral Milk Hotel's album <em>In the Aeroplane Over the Sea</em>. And then I thought, wouldn't it be funny to make some kind of website where people can time their commutes based on full-length albums? Because I commute on the subway every day. And I listen to a lot of music. And I like discovering new music. Do with this what you will.</p>
<p>There are a lot of variables when it comes to timing a subway commute (how many people are trying to take the train, whether there are any delays, etc.), so this is really just going to be an approximation, but I hope that these album suggestions at least get you most of the way through your journey.</p>
</div>
<div class="row howdoiuse">
<h1>How Do I Use This?</h1>
<ul>
<li><strong>The colored lines are subway lines.</strong> Each subway line includes a bunch of stations.</li>
<li><strong>The white dots are stations.</strong> Click one to see if there are any trips (see next bullet) that intersect with that station. Click another station to see which trips passed through <em>both</em> of those stations, and so on. Click again to unselect a station.</li>
<li><strong>The orange curvy lines are trips.</strong> The trips are the whole point of this thing. Each trip is a journey someone took on the subway, during which they where able to listen to exactly one complete album (or playlist). Hover over a trip, and at the top of the screen you'll see which stations were passed through, and what album was listened to. 
</li>
</ul>
</div>
<div class="clearfix"> </div>
<div class="row">
<h1>Tech Stuff</h1>
<p>This website is totally <em>not</em> responsive. Sorry. I'll figure that part out soon hopefully. I'm just not sure how to visualize the data on a phone, etc. (<a href="https://github.com/nelliemckesson/theellpee" target="_blank">suggestions welcome!</a>).</p>
<p>I used a lot of JavaScript, specifically d3.js. I don't have a ton of experience with this stuff yet, though. Feel free to give me tips and code suggestions <a href="https://github.com/nelliemckesson/theellpee" target="_blank">over in the GitHub project.</a></p>
<p>I didn't want to deal with setting up a database, so the data is all being fed from a Google spreadsheet. This means there can sometimes be a lag while the data is loading. It also means it may take a minute for new trips to show up (since the data gets sent from here to Google, and then back from Google to here).</p>
</div>

<div class="row fineprint">
<h1>Fine Print</h1>
<p>Here are some things I feel like I should say because of the internet:</p>
<ul>
<li>Right now LP only supports the New York subway system, but I'd like to add other cities. <a href="https://github.com/nelliemckesson/theellpee/issues">Feel free to request support for your city here.</a>
<li>This site does not host any music or files or anything. I'm just collecting data. Anyone can follow any link that is posted and do whatever with it.</li>
<li>I have a day job so my ability to make updates and bug fixes is limited, but I promise to do my best. <a href="https://github.com/nelliemckesson/theellpee/issues">You can submit bug reports or feature requests here.</a></li>
</ul>
</div>

</div>

<div class="footer">
<p>Here are some places I digitally exist: 
<a href="https://twitter.com/NellieMcKesson">Twitter</a> 
<a href="http://www.linkedin.com/profile/view?id=19217535&trk=hb_tab_pro_top">LinkedIn</a>
<a href="https://github.com/nelliemckesson">GitHub</a>
</p>
</div>

<script>
  // feeding our data from the google spreadsheet
  sourcedata = "https://script.google.com/macros/s/AKfycbw2HD7j_gy7M4CeWKiR3X-mA0wDooeZe6mc8N6axhOpDofyrTqo/exec?id=14sE-eZ8pTZe57q--HOTPJqjHYag0fWiN3Ba7YvxQ290";

  var scaleh = d3.scale.linear();
	var scalev = d3.scale.linear();
	var width = 1150,
	height = 1200;
	
	function fx(d) { return d.x; };
	function fy(d) { return d.y; };

	function fx(d) { return d.x; };
	function fy(d) { return d.y; };
	
	var rollup = d3.rollup()
    .x(function(d) { return fx(d); })
    .y(function(d) { return fy(d); });
	
d3.xml("field.svg", function(xml) {
	svgdom = document.getElementsByClassName('svgholder')[0].appendChild(xml.documentElement);

  var svg = d3.select("svg");
  var defs = d3.select("defs");

	
	scaleh.domain([0, width]);
	scaleh.range([0, 1268]);
	scalev.domain([0, height]);
	scalev.range([0, 1268]);
  

d3.json(sourcedata, function(json) {

	var graph = rollup(json);		

	var color = d3.scale.category20();

	var linkcolor = "#FF0066";

// Creating the route paths

var link = svg.selectAll("link")
	  .data(graph.links)
		.enter().append("g")
		.attr("class", "linkg")
		.attr("data-status", "inactive")
    
	svg.selectAll(".linkg")
		.data(graph.links)
		.append("path")
		.attr("class", function(d) {
			return "link " + "from" + d.source.nodes[0].Number + " to" + d.target.nodes[0].Number + " " + d.links[0].name + " " + d.links[0].fullpath;
		  })
		.attr("id" ,function(d) {
			return "link" + "from" + d.source.nodes[0].Number + "to" + d.target.nodes[0].Number;
		  })	
		// determines arc height 
		//if sx < tx, then line points right
		//if sx > tx, then line points left 
		.attr("d", function(d) {
			var sx = d.source.x * 5, sy = d.source.y,
			tx = d.target.x * 5, ty = d.target.y,
			dx = tx - sx, dy = ty - sy;
			if (sx < tx) {
				return "M" + (sx+2) + "," + sy + " C" + (sx+40) + "," + sy + " " + (tx-40) + "," + ty + " " + (tx-2) + "," + ty;
			} else if (sx > tx) {
				return "M" + (sx-2) + "," + sy + " C" + (sx-40) + "," + sy + " " + (tx+40) + "," + ty + " " + (tx+2) + "," + ty;
			} else {
				return "M" + (sx+2) + "," + sy + " C" + (sx+40) + "," + sy + " " + (tx+40) + "," + ty + " " + (tx+2) + "," + ty;
			}
		  })
		.style("stroke", linkcolor)
		.style("stroke-width", "1")
		.style("stroke-opacity", "0.6")

		.on("mouseover", function(d) {

			// see if the link is active or inactive based on node clicks
			var currStatus = d3.select(this.parentNode).attr("data-status");

			// highlight fullpaths in black when moused over
			d3.selectAll("." + d.links[0].name)
			.style("stroke-width", "2")
			.style("stroke", function(d) {
				var fpath = d.links[0].fullpath
				var arr = fpath.split("n")
				arr.pop()
				arr.shift()
				if (currStatus != null && currStatus.indexOf("activeroute") >= 0) {
					for (k = 0; k < arr.length; ++k) {
						d3.select("#" + "station" + arr[k])
						.style("fill", "black")
						.style("stroke", "white");
					}
				return "red";
				} else if (currStatus != null && currStatus.indexOf("activeroute") <= 0) {
					for (k = 0; k < arr.length; ++k) {
						d3.select("#" + "station" + arr[k])
						.style("fill", "black")
						.style("stroke", "white");
					}
				return "black";
				} else {
					for (k = 0; k < arr.length; ++k) {
						d3.select("#" + "station" + arr[k])
						.style("fill", "black")
						.style("stroke", "white");
					}
				return "black";
				}
			})

			// some blank arrays for the following operations
			var thisRoute = [];
			var endPoint = [];

			// first array returns first stop and all transfers in route
			// second array returns all transfers and last stop in route
			d3.selectAll("." + d.links[0].name).each( function(d, i){
			  var currStation = d.source.nodes[0].name + " (" + d.source.nodes[0].Line + ")"
			  thisRoute.push(currStation)
			  var myStation = d.target.nodes[0].name + " (" + d.target.nodes[0].Line + ")"
			  endPoint.push(myStation);
			});

			// pull out just the last stop and add to the complete route array
			var lastStop = endPoint.pop();
			thisRoute.push(lastStop);

			// join complete route array into a sequential string to print
			var fullRoute = thisRoute.join(" > ");

			// some blank arrays for the following operations
			var thisAlbum = [];
			var thisArtist = [];

			// return album data for selected route
			d3.selectAll("." + d.links[0].name).each( function(d, i){
			  var currAlbum = d.links[0].album
			  thisAlbum.push(currAlbum)
			  var currArtist = d.links[0].artist
			  thisArtist.push(currArtist);
			});

			// pull out just one album and artist value from the array
			var routeAlbum = thisAlbum.shift();
			var routeArtist = thisArtist.shift();

			var thisLink = [];

			// return album link
			d3.selectAll("." + d.links[0].name).each( function(d, i){
			  var currLink = d.links[0].url
			  thisLink.push(currLink);
			});

			var routeLink = thisLink.shift();

			// print route and album info at top of screen
				d3.select("#route")
				  .select("#path")
				  .text(fullRoute);

				d3.select("#route")
				  .select("#album")
				  .text(routeAlbum + " by " + routeArtist);

				d3.select("#route")
				  .select("#linky")
				  .text(routeLink);

		})
		.on("mouseout", function(d) {

			var currStatus = d3.select(this.parentNode).attr("data-status");

			d3.selectAll("." + d.links[0].name)
			.style("stroke", function(d) {
				var fpath = d.links[0].fullpath
				var arr = fpath.split("n")
				arr.pop()
				arr.shift()
				for (k = 0; k < arr.length; ++k) {
						d3.select("#" + "station" + arr[k])
						.style("fill", function(d) {
							var currNode = d3.select(this).attr("class")
							if (currNode != null && currNode.indexOf("activenode") >= 0) {
							return "black";
							} else if (currNode != null && currNode.indexOf("activenode") <= 0) {
								return "white";
							} else {
								return "white";
							}
						})
						.style("stroke", function(d) {
							var currNode = d3.select(this).attr("class")
							if (currNode != null && currNode.indexOf("activenode") >= 0) {
							return "white";
							} else if (currNode != null && currNode.indexOf("activenode") <= 0) {
								return "gray";
							} else {
								return "gray";
							}
						});
					}
				if (currStatus != null && currStatus.indexOf("activeroute") >= 0) {
				return "black";
				} else if (currStatus != null && currStatus.indexOf("activeroute") <= 0) {
				return linkcolor;
				} else {
				return linkcolor;
				}
			})
			.style("stroke-width", function(d) {
				if (currStatus != null && currStatus.indexOf("activeroute") >= 0) {
				return "2";
				} else if (currStatus != null && currStatus.indexOf("activeroute") <= 0) {
				return "1";
				} else {
				return "1";
				}
			})

		});
	  
	var node = svg.selectAll(".node")
			.data(graph.nodes)
			.enter().append("g")
			.append("line")
			.attr("x1", function(d, i) {
				return d.x * 5;
		   })
		   .attr("y1", function(d, i) {
				return d.y  - 5;
		   })
		   .attr("x2", function(d, i) {
				return d.x * 5;
		   })
		   .attr("y2", function(d, i) {
				return d.y + 5;
		   })
		   .style("stroke", function(d, i) {   
				return "#" + d.nodes[0].Color;
		   })
		   .style("stroke-width", "8");

		svg.selectAll(".node")
		.data(graph.nodes)
		.enter().append("g")
		.attr("class", "node")
		.style("pointer-events", "all")
		.append("circle")
		.attr("id", function(d, i){ return "station" + d.nodes[0].Number})
		.attr("cx", function(d, i){ 
			return d.x * 5})
		.attr("cy", function(d, i){ return d.y})
		// node circle radius
		.attr("r", 3)
		.style("fill", "white")
		.style("stroke", "grey")
		.style("stroke-width", "1")	
		.on("mouseover", function(d) {

			// positions the tooltip relative to the node
			var xPosition = (d.x * 5.29) + 62;
			var yPosition = 185 + (d.y * 1.05);
			//var yPosition = 10 + parseFloat(d3.select(this).attr("cy"));

			d3.select(this)
			.style("stroke", "white")
			.style("fill", "black");

			d3.select("#tooltip")
			  .style("left", xPosition + "px")
			  .style("top", yPosition + "px")
			  .select("#name")
			  .text(d.nodes[0].name);
			 
			d3.select("#tooltip") 
			  .select("#number")
			  .text(d.nodes[0].Line);

			d3.select("#tooltip").classed("hidden", false);
			   
		})
		.on("mouseout", function(d) {

			myClass = d3.select(this).attr("class")

			d3.select(this)
			.style("stroke", function(d) { 
				if (myClass != null && myClass.indexOf("activenode") >= 0) {
					return "white";
				} else if (myClass != null && myClass.indexOf("activenode") <= 0) {
					return "gray";
				} else {
					return "gray";
				}
			})
			.style("fill", function(d) { 
				if (myClass != null && myClass.indexOf("activenode") >= 0) {
					return "black";
				} else if (myClass != null && myClass.indexOf("activenode") <= 0) {
					return "white";
				} else {
					return "white";
				}
			});

			d3.select("#tooltip").classed("hidden", true);
			//d3.select(this).style("fill", "white");
		})

// on click, toggle class of clicked
// then select all lines with a class that contains the n for all nodes that are clicked
		.on("click", function(d) {

			d3.select(this).attr("class", function(d) { 
				myClass = d3.select(this).attr("class")
				if (myClass != null && myClass.indexOf("activenode") >= 0) {
					return "inactive";
				} else if (myClass != null && myClass.indexOf("activenode") <= 0) {
					return "activenode";
				} else {
					return "activenode";
				}
			});

			// positions the tooltip relative to the node
			var xPosition = scaleh(50 + parseFloat(d3.select(this).attr("cx")));
			var yPosition = scalev(10 + parseFloat(d3.select(this).attr("cy")));

			// for each activenode, store node number in an array
			// take the array and find routes that contain every value in the array

			var activenodes = [];

			d3.selectAll(".activenode").each( function(d, i){
			  var nodeId = d3.select(this).attr("id")
			  var nodeNum = nodeId.replace("station", "")
			  activenodes.push(nodeNum);
			});

			d3.selectAll(".linkg").each( function(d, i){
				var routeArr = []
				var routeNums = d.links[0].fullpath
					for (var j = 0; activenodes.length > j; j++) {
						var nodeN = "n" + activenodes[j] + "n"
						if (routeNums.indexOf(nodeN) >= 0) {
							routeArr.push("yes")
						}
					}
				if (routeArr.length > 0 && routeArr.length == activenodes.length) {
					d3.select(this).attr("data-status", "activeroute")
				} else {
					d3.select(this).attr("data-status", "inactive")
				}
			});

			// Selects routes that contain all selected nodes
			d3.selectAll('[data-status="activeroute"]').select("path")
			.transition()
			.duration(10)
			.style("stroke", "black")
			.style("display", "block")
			.style("stroke-opacity", "1")
			.style("stroke-width", "2");

			// Clears selection if route no longer meets the requirements
			d3.selectAll('[data-status="inactive"]').select("path")
			.transition()
			.duration(10)
			.style("stroke", linkcolor)
			.style("display", "block")
			.style("stroke-opacity", "1")
			.style("stroke-width", "1")
			.style("pointer-events", "all");

			// selected nodes are black
			d3.selectAll(".activenode")
			.style("fill", "black")
			.style("stroke", "white");

			// inactive nodes are white
			d3.selectAll(".inactive")
			.style("fill", "white")
			.style("stroke", "gray");

		});

		// append shortened station name to right of node
		svg.selectAll(".node")
			.data(graph.nodes)
			.append("text")
		    .text(function(d, i) {   
				return d.nodes[0].name.substring(0,5) + "...";
		    })
		    .attr("x", function(d, i) {
				return d.x * 5 + 5;
		    })
		    .attr("y", function(d, i) {
				return d.y;
		    })
		    .style("font-family", "monospace")
		    .style("font-size", "7px")
		    .style("text-anchor", "right")
		    .style("dominant-baseline", "central")
		    .style("stroke", "#999")
		    .style("stroke-opacity", "0.6")
		    .style("pointer-events", "none");

	});
});

</script>
</body>
</html>